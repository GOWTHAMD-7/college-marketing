import { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import './StudentSegmentation.css'

interface SegmentData {
  name: string
  count: number
  percentage: number
  color?: string
}

interface Insight {
  icon: string
  title: string
  description: string
}

interface AnalysisData {
  total_students: number
  segments_created: number
  geographic_segments: SegmentData[]
  academic_segments: SegmentData[]
  socioeconomic_segments: SegmentData[]
  marketing_channels: SegmentData[]
  accommodation_segments: SegmentData[]
  parent_sentiments: SegmentData[]
  insights: Insight[]
}

function StudentSegmentation() {
  const navigate = useNavigate()
  const [csvFile, setCsvFile] = useState<File | null>(null)
  const [isAnalyzing, setIsAnalyzing] = useState(false)
  const [isLoading, setIsLoading] = useState(true)
  const [analysisData, setAnalysisData] = useState<AnalysisData | null>(null)
  const [showUploadModal, setShowUploadModal] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Load initial analysis on component mount
  useEffect(() => {
    loadInitialAnalysis()
  }, [])

  const loadInitialAnalysis = async () => {
    try {
      setIsLoading(true)
      setError(null)
      
      const response = await fetch('http://localhost:8000/api/segmentation/initial-analysis')
      
      if (!response.ok) {
        throw new Error('Failed to load analysis data')
      }
      
      const data = await response.json()
      setAnalysisData(data)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred')
      console.error('Error loading initial analysis:', err)
    } finally {
      setIsLoading(false)
    }
  }

  const assignColors = (segments: SegmentData[]): SegmentData[] => {
    const colors = ['#00D4FF', '#1E2A78', '#7C88CC', '#00BDEB', '#3A4A9A']
    return segments.map((seg, idx) => ({
      ...seg,
      color: colors[idx % colors.length]
    }))
  }

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file && file.name.endsWith('.csv')) {
      setCsvFile(file)
    } else {
      alert('Please upload a valid CSV file')
    }
  }

  const handleAnalyze = async () => {
    if (!csvFile) {
      alert('Please upload a CSV file first')
      return
    }

    setIsAnalyzing(true)
    setError(null)
    
    try {
      const formData = new FormData()
      formData.append('file', csvFile)
      
      const response = await fetch('http://localhost:8000/api/segmentation/analyze-new-data', {
        method: 'POST',
        body: formData
      })
      
      if (!response.ok) {
        const error = await response.json()
        throw new Error(error.detail || 'Failed to analyze data')
      }
      
      const data = await response.json()
      setAnalysisData(data)
      setShowUploadModal(false)
      setCsvFile(null)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'An error occurred')
      alert(err instanceof Error ? err.message : 'Failed to analyze data')
    } finally {
      setIsAnalyzing(false)
    }
  }

  const handleBack = () => {
    navigate('/teacher-dashboard')
  }

  return (
    <div className="segmentation-container">
      <header className="segmentation-header">
        <button className="back-button" onClick={handleBack}>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
          </svg>
          Back to Dashboard
        </button>
        <div className="header-title">
          <div className="ai-icon">
            <svg width="40" height="40" viewBox="0 0 48 48" fill="none">
              <circle cx="24" cy="24" r="20" stroke="#00D4FF" strokeWidth="2" />
              <circle cx="18" cy="20" r="2" fill="#00D4FF" />
              <circle cx="30" cy="20" r="2" fill="#00D4FF" />
              <path d="M16 28C16 28 18 32 24 32C30 32 32 28 32 28" stroke="#00D4FF" strokeWidth="2" strokeLinecap="round" />
              <path d="M12 24L8 20M36 20L40 24M24 8V4" stroke="#00D4FF" strokeWidth="1.5" strokeLinecap="round" />
            </svg>
          </div>
          <div>
            <h1>Student Admission Segmentation</h1>
            <p className="powered-by">Powered by AI Machine Learning</p>
          </div>
        </div>
      </header>

      <main className="segmentation-main">
        {!analysisComplete ? (
          <div className="upload-section">
            <div className="upload-card">
              <div className="upload-icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" stroke="#1E2A78" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
              </div>
              <h2>Upload Student Data</h2>
              <p>Upload a CSV file containing student admission records for AI-powered segmentation analysis</p>
              
              <div className="file-input-wrapper">
                <input
                  type="file"
                  id="csv-upload"
                  accept=".csv"
                  onChange={handleFileUpload}
                  className="file-input"
                />
                <label htmlFor="csv-upload" className="file-label">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  Choose CSV File
                </label>
              </div>

              {csvFile && (
                <div className="file-selected">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="#00D4FF" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                    <polyline points="22 4 12 14.01 9 11.01" stroke="#00D4FF" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                  {csvFile.name}
                </div>
              )}

              <button 
                className="analyze-button"
                onClick={handleAnalyze}
                disabled={!csvFile || isAnalyzing}
              >
                {isAnalyzing ? (
                  <>
                    <div className="spinner"></div>
                    Analyzing...
                  </>
                ) : (
                  <>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                      <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/>
                      <path d="M12 6v6l4 2" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/>
                    </svg>
                    Start AI Analysis
                  </>
                )}
              </button>

              <div className="info-box">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="#1E2A78" strokeWidth="2"/>
                  <line x1="12" y1="16" x2="12" y2="12" stroke="#1E2A78" strokeWidth="2" strokeLinecap="round"/>
                  <line x1="12" y1="8" x2="12.01" y2="8" stroke="#1E2A78" strokeWidth="2" strokeLinecap="round"/>
                </svg>
                <div>
                  <strong>Expected CSV Format:</strong>
                  <p>student_name, gender, school_type, cutoff_12th, city, accommodation, source, quota, student_goal</p>
                </div>
              </div>
            </div>
          </div>
        ) : (
          <div className="results-section">
            <div className="results-header">
              <h2>Segmentation Analysis Results</h2>
              <button className="export-button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
                Export Report
              </button>
            </div>

            <div className="stats-grid">
              <div className="stat-card">
                <div className="stat-icon" style={{ background: 'rgba(0, 212, 255, 0.1)' }}>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="#00D4FF" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </div>
                <div className="stat-content">
                  <h3>1,000</h3>
                  <p>Total Students</p>
                </div>
              </div>

              <div className="stat-card">
                <div className="stat-icon" style={{ background: 'rgba(30, 42, 120, 0.1)' }}>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2M8.5 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM20 8v6M23 11h-6" stroke="#1E2A78" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </div>
                <div className="stat-content">
                  <h3>7</h3>
                  <p>Segments Created</p>
                </div>
              </div>

              <div className="stat-card">
                <div className="stat-icon" style={{ background: 'rgba(0, 212, 255, 0.1)' }}>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="#00D4FF" strokeWidth="2"/>
                    <path d="M12 6v6l4 2" stroke="#00D4FF" strokeWidth="2" strokeLinecap="round"/>
                  </svg>
                </div>
                <div className="stat-content">
                  <h3>91.2%</h3>
                  <p>Avg Accuracy</p>
                </div>
              </div>

              <div className="stat-card">
                <div className="stat-icon" style={{ background: 'rgba(30, 42, 120, 0.1)' }}>
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" stroke="#1E2A78" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/>
                  </svg>
                </div>
                <div className="stat-content">
                  <h3>4</h3>
                  <p>ML Models Used</p>
                </div>
              </div>
            </div>

            <div className="segments-grid">
              <div className="segment-card">
                <h3>Geographic Distribution</h3>
                <div className="segment-chart">
                  {geographicSegments.map((segment) => (
                    <div key={segment.name} className="segment-bar">
                      <div className="segment-label">
                        <span>{segment.name}</span>
                        <span className="segment-value">{segment.count} ({segment.percentage}%)</span>
                      </div>
                      <div className="progress-bar">
                        <div 
                          className="progress-fill" 
                          style={{ width: `${segment.percentage}%`, background: segment.color }}
                        ></div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="segment-card">
                <h3>Academic Performance</h3>
                <div className="segment-chart">
                  {academicSegments.map((segment) => (
                    <div key={segment.name} className="segment-bar">
                      <div className="segment-label">
                        <span>{segment.name}</span>
                        <span className="segment-value">{segment.count} ({segment.percentage}%)</span>
                      </div>
                      <div className="progress-bar">
                        <div 
                          className="progress-fill" 
                          style={{ width: `${segment.percentage}%`, background: segment.color }}
                        ></div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="segment-card">
                <h3>Socio-Economic Status</h3>
                <div className="segment-chart">
                  {socioeconomicSegments.map((segment) => (
                    <div key={segment.name} className="segment-bar">
                      <div className="segment-label">
                        <span>{segment.name}</span>
                        <span className="segment-value">{segment.count} ({segment.percentage}%)</span>
                      </div>
                      <div className="progress-bar">
                        <div 
                          className="progress-fill" 
                          style={{ width: `${segment.percentage}%`, background: segment.color }}
                        ></div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="segment-card">
                <h3>Marketing Channel Effectiveness</h3>
                <div className="segment-chart">
                  {marketingChannels.map((segment) => (
                    <div key={segment.name} className="segment-bar">
                      <div className="segment-label">
                        <span>{segment.name}</span>
                        <span className="segment-value">{segment.count} ({segment.percentage}%)</span>
                      </div>
                      <div className="progress-bar">
                        <div 
                          className="progress-fill" 
                          style={{ width: `${segment.percentage}%`, background: segment.color }}
                        ></div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            <div className="model-performance-section">
              <h3>ML Model Performance</h3>
              <div className="performance-grid">
                {modelPerformance.map((model) => (
                  <div key={model.segment} className="performance-card">
                    <div className="performance-header">
                      <span className="performance-segment">{model.segment}</span>
                      <span className="performance-accuracy">{(model.accuracy * 100).toFixed(1)}%</span>
                    </div>
                    <div className="performance-bar">
                      <div 
                        className="performance-fill" 
                        style={{ width: `${model.accuracy * 100}%` }}
                      ></div>
                    </div>
                    <div className="performance-model">Best: {model.bestModel}</div>
                  </div>
                ))}
              </div>
            </div>

            <div className="insights-section">
              <h3>Key Marketing Insights</h3>
              <div className="insights-grid">
                <div className="insight-card">
                  <div className="insight-icon">üìç</div>
                  <h4>Local Market Dominance</h4>
                  <p>42.5% of students are from local areas (Erode, Coimbatore). Focus on strengthening day-scholar facilities.</p>
                </div>
                <div className="insight-card">
                  <div className="insight-icon">üíª</div>
                  <h4>Digital Channel Success</h4>
                  <p>44% of admissions come from digital channels. Increase investment in social media and Google ads.</p>
                </div>
                <div className="insight-card">
                  <div className="insight-icon">üéØ</div>
                  <h4>Metro Expansion Opportunity</h4>
                  <p>28.5% metro students show growth potential. Target Chennai and Bangalore with specialized campaigns.</p>
                </div>
                <div className="insight-card">
                  <div className="insight-icon">ü§ù</div>
                  <h4>Referral Program Value</h4>
                  <p>35% through referrals with high conversion rates. Strengthen alumni and parent referral incentives.</p>
                </div>
              </div>
            </div>
          </div>
        )}
      </main>
    </div>
  )
}

export default StudentSegmentation
